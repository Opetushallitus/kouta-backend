sudo: required
dist: xenial
language: scala
scala:
  - 2.12.10
jdk:
  - openjdk8
services:
  - docker
  - postgresql

addons:
  postgresql: "11"
  apt:
    packages:
      - postgresql-11
      - postgresql-client-11

cache:
  directories:
  - $HOME/.m2

env:
  global:
    - PGPORT=5433
    # AWS_ACCESS_KEY_ID
    - secure: "A5YhLsl6xZWcrG7ETTi6X9VkLwEZEmZTOikYKGDtts7ryGAYT6IZ5JvLad/XWZWoa+6aEihAe2Sc+oc9ORppp0D/VA0UJ1hWcNcrX+IsS0rDtRO1Y1sHFc18nwSnXCrzKQy9kw5+5VZ2YzisV7PPivyzl0DhYg0GDbW4X3umvfFi6UZ9OhHBkepkdZ3zSYs8ggYixWk5r1Yxu7YYsnmtOUTvxQu/SU0XN4Q0xL9eiJN1Nw5X/qSqFboPoHzYRGRhRZFIT3JvYakGIoShLw7W0krc8RS/cHAXwgXK9+QMSlEVam48+J88Y3v0gX+vfgc7PDL8ZZXRbUu84FEUNBRtDmtao5CncHI2sFzYhOmf+2rgkueyWiGNb/tsmc540wi9zdwflWP1p2LYovKFtVywykLMZ26nxB9QD0vV2ehIMc43H1ard8Y+GQPZjLOBhwenG0fMqtyMunxuagrfBi8BumE7OXCPJW/2E6piIQLitct8RiidnCJaVb+JXFWflrKUapMT9qYg6L1UngJ3OAWZzWsF2ortduMFFj6sAJxrZEOQlAnvmuHtEW+zcZNjboio9TiA6Nb7dyvh3h+hXeIYpAk3ifhxAyYqjTe6JNbGAzwDK7f3IlKBROcEzSzwSBEkDK603N9AaPs80Ahqc6dDm69FzsaC9w5+nFmTCIU2qfw="
    # AWS_SECRET_ACCESS_KEY
    - secure: "hpRAl4znS68nf1HLudmsT6dapNefp1Wu8i6hEVRkvmNXD4Sjq8rbIop2SC3DMBLuq/2s9DwogX0nT544g7YlPYz9Q4QgqKUvEE8LKOHRHZCCxiJMpkUOlUJPWqhzeLCBI8Wh0JQiqvvjnpH9X54buQrdWK6C6Td2RNAaJjP7SHz8uz/wHCgMLlTl4HZ29xwzMM6WE+4t+D44Ed0PU+0srgBunLmzqoEU1eLxvQ8YauV7hnq7LrSd/2cyGCmKO0PSfGYN2X6jlwMde9Aa7ZWkL6iVwqrhuWlq+Tq8/dXIFEEjP74RLigfX5L9zzkNoDxiAT5Kbahhn4y1S9KNiwpth574L+GBn/CfteWs4h0A97wQE4MUxnN+ez8z+B64gYyRhVX559VcGlP3C10K3rwc8ibALQPuoE3lqmVYHpzxgRMFV5BYRjYgpg8g2N+qksPqBkFWzoNOd90IVWSL1h4eO2vPtwr520K5DUOCgsgKSnQlO4wdj5bspUGJ0RqOxICP82BMUtXrb36yb8tTqLcmRP6Mccc39VLLsltgsdewDqHKhRByIfneR0+oO8t1gd0hCgpHv10qhrcumQpUMNDfWmWX0Z1a4jF7QPuQpijc407tIFfQPLTZ4iPIPZUfTaPyOfINNQh9Bteu+dgqVKOETi1xLwmORwsupl1f+/QIcNA="
    # ARTIFACTORY_USERNAME
    - secure: "AAIOl2pB5/cT7sBMXlbUz5fYJQdmlP5fKTT9TJbRQg+J8JVmPtEc4RLRek8G8kSlurW/7Dq9dhetA14ap2XCqCBwubMKy59XVVM9ASELIg3v6htZ2l9TLKAX9HLGwGUaN8l0TyZlyxKaqIKE8OZu6qyQqN4wIYDDj2vrP98RZly+i4bXsNCTJO4QBnxaXEH6w/gLZlAU3OcNa675bUfm+uN9ykSzXmKnOzYVBt8VwiHbeh9GuARr9Xb9Dg0a4VBnBwI9xy9BNRav5P0DgT+Wd5YF4HmUpogCPoLBZr8o8EDAoBNbfwikKs1efQ07aX/CIPgzOtELfkP2gUXOWdKi+UP8dBv1IK0if2EFd4dUr4yGlV43StOfwlytbzG8LMxJrnWBFUA1B/W4FXzHjVPoadSgn/19z/hvZqLuct2o1UCS0Xm179LtIelZoIHwHE+Uq0DZ4/a78utqAc8IUH424iuTBasG7PFwsqiBLWZlW/3hkvlP4Imx4vJ0PWCcX5gpmyYxMX/p2JMoCM/za1QHK7pUdchp1KtXihWWYIs2cod6s9IPwoeSL30T3RLDqfwCIrytNVdrCLtuHf2sWwieb5nLHY/gMUpt7wvkNBI+PlRonjiD2Y538oRtROxoJ2emL3BFLj9AttnRzPQn5Oy0ttrgZJffKEUjMK+XqyqA2E0="
    # ARTIFACTORY_PASSWORD
    - secure: "Kx+Pv/ZUwfZH2uNMOw7Cc0oqF/qhGjSgCFVEapC3A2YVs3APq+WgCf1z2kH2j92quliWq/jmNj0b0Ef2KSYi7FhCr22QGbxaUGu9seILpSB+5S5ddMwmNYgA7Dr0F6ABXn/luajbT3YlcgeMgMGkmU9zrns1Cak6dq//pgG/mmBMEUJ9uLvJWQzH5ZAe9dCJJRJfEOfHadud+9zkXQ/08q2S4b8Ri0004JS1LtlsIimv0ZoMspPpnsWIRpKgPEsSGNZ3Aptj4Jli83f0iAi5REZs+5ZLeJXXNDosPdfVgqs0UPkktD3XHLZJ1PeVawxL8H4tCHuMVTQvjBPhAL2TN0OOqDVlO0R1ef2UhtBEOSLRK7nzUa1TiTleDws64LO1nmCsAJu1geA+RXg6aSB4votW3ngp9BI19Z84LJUTRm5c6F0eThsDwxMysSTiu1dj7mvSvTl1UxwZcb+3Nl10f36pspcngyWW4Ogq78Nr0v3bw8gGsYNb+4Rjico/QJtWXsnnACnsGRfNA/RwqJJKptkC7DSil9Hj6hLK6XkRexApol9HO57FZwBfkOuanMJ87ZOzIvrvOlDtjsEOShHYz/5tzqRCmp84vSyUNCkSHVY3oWf3exC1u8bR3Hi3AfROOmgfLN1QIJW+VNMVYQu7d/I1vcIYDOISCTS+Q0v0Qd0="

before_install:
  # https://github.com/travis-ci/travis-ci/issues/9624
  - sudo sed -i -e '/local.*peer/s/postgres/all/' -e 's/peer\|md5/trust/g' /etc/postgresql/*/main/pg_hba.conf
  - sudo systemctl restart postgresql@11-main
  - sleep 1

install:
  - git clone https://github.com/Opetushallitus/ci-tools.git
  - source ci-tools/common/setup-tools.sh
  - export ARTIFACT_NAME="kouta-backend"

before_script:
  - DB_NAME=kouta
  - psql -c "create database $DB_NAME WITH ENCODING 'UTF8' LC_COLLATE='C' LC_CTYPE='C' TEMPLATE template0;" -U postgres
  - psql -d $DB_NAME -f kouta-backend/postgresql/init_it_postgresql.sql
  - docker pull localstack/localstack:0.10.2

script:
  - mvn clean package --batch-mode -DargLine="-Dkouta-backend.test-postgres-port=${PGPORT}"

  - mv kouta-backend/target/kouta-backend-*-jar-with-dependencies.jar $DOCKER_BUILD_DIR/artifact/${ARTIFACT_NAME}.jar
  - cp -vr kouta-backend/src/main/resources/* $DOCKER_BUILD_DIR/config/

  - export BASE_IMAGE="baseimage-fatjar-openjdk8:master"
  - ./ci-tools/common/pull-image.sh
  - ./ci-tools/build/build-fatjar.sh $ARTIFACT_NAME

deploy:
  - provider: script
    script:
      mvn deploy -DskipTests --settings ci-tools/common/maven-settings.xml
    skip_cleanup: true
    on:
      branch: KTO-1453-kopiointirajapinta-hakukohteille
  - provider: script
    script:
      ./ci-tools/build/upload-image.sh $ARTIFACT_NAME
    on:
      all_branches: true

